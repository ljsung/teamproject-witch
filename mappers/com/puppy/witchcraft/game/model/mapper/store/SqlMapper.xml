<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.puppy.witchcraft.game.model.mapper.store.SqlMapper">

	<resultMap type="com.puppy.witchcraft.game.model.dto.ItemDTO" id="StorePageItemDTO" >
		<id property="itemNo" column="ITEM_NO"/>
		<result property="itemType" column="ITEM_TYPE"/>
		<result property="itemName" column="ITEM_NAME"/>
		<result property="itemInfo" column="ITEM_INFO"/>
		<result property="itemSell" column="ITEM_SELL"/>
		<result property="itemBuy" column="ITEM_BUY"/>
		<result property="imageNo" column="IMAGE_NO"/>
	</resultMap>
	
	<resultMap id="imageResultMap" type="com.puppy.witchcraft.game.model.dto.ImageDTO">
	<id property="imageNo" column="IMAGE_NO"/>
	<result property="imageSave" column="IMAGE_SAVE"/>
	<result property="imageName" column="IMAGE_NAME"/>
	<result property="imageType" column="IMAGE_TYPE"/>
	</resultMap>

	<resultMap id="playerResultMap" type="com.puppy.witchcraft.game.model.dto.PlayerDTO">
	<id property="playerNo" column="PLAYER_NO"/>
	<result property="playerId" column="PLAYER_ID"/>
	<result property="playerPwd" column="PLAYER_PWD"/>
	<result property="playerNickname" column="PLAYER_NICKNAME"/>
	<result property="playerGold" column="PLAYER_GOLD"/>
	</resultMap>

	<resultMap id="itemInvenResultMap" type="com.puppy.witchcraft.game.model.dto.MyItemInven">
	<id property="itemNo" column="ITEM_NO"/>
	<result property="itemCount" column="ITEMCOUNT"/>
	<result property="imageNo" column="IMAGE_NO"/>
	</resultMap>
	
   <resultMap id="selectItemInvenResultMap" type="com.puppy.witchcraft.game.model.dto.ItemInvenDTO">
	<id property="invenNo" column="INVEN_NO"/>
	<result property="playerNo" column="P_NO"/>
	<result property="itemNo" column="ITEM_NO"/>
	</resultMap>

	<select id="sellItem" resultMap="selectItemInvenResultMap" parameterType="com.puppy.witchcraft.game.model.dto.ItemInvenDTO" >
	delete from item_inven
	where inven_no = 
	(
	select p.inven_no
       	   from 
       	   (
              	  select rownum r, v.*
                  from (
                     	 select *
                     	 from item_inven
                         where item_no = #{ itemNo }
                           and p_no = #{ playerNo }
                         order by inven_no
                  ) v
               
           )p
WHERE p.R = 1
)
	

	</select> 

	<select id="myItemInven" resultMap="itemInvenResultMap" parameterType="_int">
	SELECT
	       A.ITEM_NO
         , COUNT(*) as ITEMCOUNT
         , A.IMAGE_NO
 	  FROM ITEM A
  	  JOIN ITEM_INVEN B ON(A.ITEM_NO = B.ITEM_NO)
  	 WHERE B.P_NO = 1
     GROUP BY A.ITEM_NO, A.IMAGE_NO
     HAVING COUNT(*) > 0
</select>

	<select id="storeList" resultMap="StorePageItemDTO">
		SELECT
		    A.ITEM_NO
		  , A.ITEM_TYPE
		  , A.ITEM_NAME
		  , A.ITEM_INFO
		  , A.ITEM_SELL
		  , A.ITEM_BUY
		  , A.IMAGE_NO
	    FROM ITEM A
	   WHERE A.ITEM_TYPE = 'STORE'
	</select>
	
	<select id="imageUrl" resultMap="imageResultMap" parameterType="_int">
	SELECT
		   I.IMAGE_NO
		 , I.IMAGE_SAVE
		 , I.IMAGE_NAME
		 , I.IMAGE_TYPE
	  FROM IMAGE I
	 WHERE IMAGE_NO = #{ imageNo }
	 
	</select>

    <update id="playerGoldChange" parameterType="com.puppy.witchcraft.game.model.dto.PlayerDTO">
	UPDATE
	       PLAYER P
	   SET
	       P.PLAYER_GOLD = #{ playerGold }
	 WHERE P.P_NO = #{ playerNo }
	  
	</update>
	
	
	<insert id="insertstoreitem" parameterType="hashmap">
      INSERT 
        INTO ITEM_INVEN
       (
        INVEN_NO,
        P_NO,
        ITEM_NO
       )
       VALUES
       (
         SEQ_ITEM_INVEN_NO.NEXTVAL,
         #{ playerNo },
         #{ itemNo }
       )
   </insert>
   
</mapper>